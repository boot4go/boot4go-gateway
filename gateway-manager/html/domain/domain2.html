<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:jc="http://www.joinsunsoft.com">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <script src="/static/common/js/ui.js"></script>
</head>

<body>
<div id="loading" class="loading-wrap">
    <div class="loading-content">
        <div class="loading-round"></div>
        <div class="loading-dot"></div>
    </div>
</div>
<script id="tmpl1" type="text/x-jquery-tmpl">
<table id="productDg"></table>
<!-- 表格工具栏开始 -->
<div id="productDg-toolbar" class="cubeui-toolbar"
     data-options="grid:{
           type:'datagrid',
           id:'productDg'
       }">

    <a  href="javascript:void(0)" data-toggle='cubeui-menubutton' data-options="{
            method1: 'openDialog',
            onClick:function(){
                openEditDiag();
            },
            extend: '#productDg-toolbar',
            btnCls: 'cubeui-btn-orange',
            iconCls: 'fa fa-plus'
        }">新增</a>

    <form id="queryForm" class="search-box">
    	<input type="text" name="email" data-toggle="cubeui-textbox"
               data-options="id:'email',prompt:'ID查询',width:360">
        <a href="javascript:void(0)"
           data-toggle="cubeui-menubutton"
           data-options="method:'query',
           iconCls:'fa fa-search',
           btnCls:'cubeui-btn-blue',
           form:{id:'queryForm'},
           grid:{type:'datagrid','id':'productDg'}">查询</a>
    </form>
</div>
<!-- 表格工具栏结束 -->
</script>

</body>
<script>
    new APP(function () {
        return {
            css: [],
            js: [

            ],
            render: function () {
                stop = true
                console.log("finish")

                APP.renderBody("#tmpl1", {id:"1022", name:"davidliu"})

                // let t = $.templates("#tmpl1").render({id:"1022", name:"davidliu"})
                // $('body div').remove()
                // $(t).appendTo($('body'))
            }
        }
    });

    function load() {
        jquery(function () {
            var productDg = {
                type: 'datagrid',
                id: 'productDg'
            };

            $("#productDg").iDatagrid({
                url: V3_API_URL + '/domain/list',
                idField: 'ID',
                sortName: 'COMPANYNO',
                sortOrder: "asc",
                frozenColumns:[[
                    // {field: 'id', title: '', checkbox: true},
                    {field: 'id', title: 'ID', sortable: false,
                        formatter:$.iGrid.templateformatter('{id}'),
                        width: 350},
                ]],
                columns: [[
                    {
                        field: 'domain_name',
                        title: '名称',
                        sortable: true,
                        width: 180,
                        formatter:$.iGrid.tooltipformatter()
                    },
                    {field: 'domain_url', title: '域名', sortable: false, width: 240,
                        formatter: function(value, row, index){
                        return '<a onclick=\"openEditDomainDiag(\'' + row.id + '\');return false\" class=\'cubeui-link\' href=\'#\'>'+value+'</a>'
                        }},
                    {field: 'lb_type', title: '负载均衡', sortable: false, width: 100,
                        formatter:$.iGrid.checkedformatter("roundRobin", "<span class=\"cube-label cube-label-orange\">轮询</span>", "<span class=\"cube-label cube-label-blue\">随机</span>")},
                    {field: 'set_time', title: '创建日期', sortable: false, width: 160},
                    {field: 'op', title: '操作', sortable: false, width: 380, formatter:operateFormatter}
                ]],
                loadFilter: function (data) {
                    // add checkedRows test data, just for debug
                    var d = $.fn.iDatagrid.defaults.loadFilter.call(this, data);
                    //d.checkedRows = [999, 22];
                    return d;
                }
            });
        });
    }

    function operateFormatter(value, row, index) {
        var htmlstr = "";

        htmlstr += '<button class="layui-btn cubeui-btn-ivory layui-btn-xs" onclick="openEditDiag(\'' + row.id + '\')">修改信息</button>';
        htmlstr += '<button class="layui-btn layui-btn-danger layui-btn-xs" onclick="openEditDomainDiag(\'' + row.id + '\')">修改域名</button>';
        htmlstr += '<button class="layui-btn layui-btn-danger layui-btn-xs" onclick="openPathDiag(\'' + row.id + '\')">路径映射</button>';
        htmlstr += '<button class="cubeui-btn-gray layui-btn layui-btn-xs" onclick="delDomain(\'' + row.id + '\')">删除域名</button>';

        return htmlstr;
    }

    function openEditDomainDiag(id){
        $.iDialog.openDialog({
            title: '修改域名',
            minimizable:false,
            content: `
            <div style="margin: 0px;">
            </div>
            <div class="cubeui-fluid" id="company-detail-form">
                <div class="cubeui-row">
                    <label class="cubeui-form-label">域名:</label>
                    <div class="cubeui-input-block">
                        <input type="text" data-toggle="cubeui-textbox" id="domain_url" name="domain_url"
                               value='{{:domain_url}}' data-options="required:true,prompt:'域名+端口，必须填写'">
                    </div>
                </div>
            </div>
            `,
            width: 500,
            height: 160,
            render:function(opts, handler){
                let d = this;
                console.log("Open dialog")

                $.app.get(V3_API_URL + '/domain/'+id, null, function (data) {
                    handler.render(data.data)
                });
            },
            buttonsGroup: [{
                text: '保存',
                iconCls: 'fa fa-save',
                btnCls: 'cubeui-btn-blue',
                handler:'ajaxForm',
                requestType:'put',
                reload: [{type:'datagrid', id:'productDg', keepcheck:0}],
                url:V3_API_URL + '/domain/url/'+id
            }]
        });
    }

    function delDomain(id){
        $.app.confirm(null, "确认删除域名"+id, function (){
            $.app.deleteJson(V3_API_URL + '/domain/'+id, null, function (data) {
                $.app.show(data.msg);
                $('#productDg').datagrid('reload')
            })
        })
    }

    function openEditDiag(id){

        $.iDialog.openDialog({
            title: '编辑',
            maximized:true,
            minimizable:false,
            width: 850,
            height: 650,
            render:function(opts, handler){
                let d = this;
                console.log("Open dialog")

                if(id!=null){
                    $.app.get(V3_API_URL + '/domain/'+id, null, function (data) {
                        handler.render(data.data)
                        $(d).dialog('setTitle', '域名：' + id)

                        $("#domain_url").textbox('readonly')

                        $("#rate_limiter_enabled").switchbutton('options').onChange = function(checked){
                            if(checked){
                                $("#rate_limiter_num").numberspinner('enable')
                                $("#rate_limiter_msg").numberspinner('enable')
                            }else{
                                $("#rate_limiter_num").numberspinner('disable')
                                $("#rate_limiter_msg").numberspinner('disable')
                            }
                        }

                        if (data.data.rate_limiter_enabled == false || data.data.rate_limiter_enabled == 'false') {
                            $("#rate_limiter_enabled").switchbutton('uncheck')
                        }else{
                            $("#rate_limiter_enabled").switchbutton('check')
                        }

                        initContactDg(data)
                    });
                }  else{
                    handler.render({id:'add'})
                    $(d).dialog('setTitle', '新增域名')

                    $('#domainIdDiv').hide()
                    $("#domain_url").textbox('readonly', false)
                    $("#domain_name").textbox('readonly', false)

                    $("#rate_limiter_enabled").switchbutton('options').onChange = function(checked){
                        if(checked){
                            $("#rate_limiter_num").numberspinner('enable')
                            $("#rate_limiter_msg").numberspinner('enable')
                        }else{
                            $("#rate_limiter_num").numberspinner('disable')
                            $("#rate_limiter_msg").numberspinner('disable')
                        }
                    }

                    $("#rate_limiter_enabled").switchbutton('uncheck')

                    initContactDg({})
                }
            },
            href: contextpath + '/domain/domain-detail.html?id='+id,
            buttonsGroup: [{
                text: '保存',
                iconCls: 'fa fa-save',
                reload: [{type:'datagrid', id:'productDg', keepcheck:0}],
                btnCls: 'cubeui-btn-blue',
                handler:'ajaxForm',
                requestType:'put',
                beforeAjax:function(o){
                    $('#contactDg').datagrid("acceptChanges")
                    var rows = $('#contactDg').datagrid('getRows');
                    if(rows.length==0){
                        $.app.showerror('请至少添加一个目标地址');
                        return false;
                    }
                    var d = [];
                    $.each(rows, function(idx, row){
                        var o = {};
                        o.pointer = row.pointer;
                        o.weight = row.weight;
                        d.push(o);
                    });

                    o.ajaxData = $.extends.json.param2json(o.ajaxData);
                    o.ajaxData.targets = d
                    //var d = $.param({contacts:$.extends.json.tostring(d)});
                    //o.ajaxData = $.extends.json.tostring(o.ajaxData)

                    $.app.debug(o.ajaxData);
                },
                postJson:true,
                url:V3_API_URL + '/domain/'+(id||'add')
            }]
        });
    }

    function initContactDg(data){

        $("#contactDg").iDatagrid({
            pagination:false,
            idField:'ID',
            remoteSort:false,
            sortOrder:"asc",
            data:{rows:(data&&data.data&&data.data.targets)?data.data.targets:[]},
            singleSelect:true,
            onDblClickRow:$.iGrid.EdatagridHandle.rowEditRowEventHanle(function(idx, row, colopts){
            }),
            columns: [[
                {field: 'ID', title: '', checkbox: true},
                {field: 'pointer', title: '目标地址',width:350, editor:{type:'textbox',options:{required:true, prompt:"目标地址(域名/IP+Port)，必须填写"}},
                    sortable: true, formatter:$.iGrid.tooltipformatter()},
                {field: 'weight', title: '权重',width:150, editor:{type:'numberspinner',options:{required:true,prompt:"目标地址权重",value:0, min:0,increment:10}}, sortable: true,
                    formatter:$.iGrid.tooltipformatter()},
            ]]
        });
    }

    function openPathDiag(id){

        $.iDialog.openDialog({
            title: '编辑',
            maximized1:true,
            minimizable:false,
            width: 1250,
            height: 650,
            render:function(opts, handler){
                let d = this;
                console.log("Open dialog")

                $.app.get(V3_API_URL + '/path/'+id, null, function (data) {
                    data.data.domainId = id;
                    handler.render(data.data)

                    $(d).dialog('setTitle', '域名路径映射：' + id)

                    initPathList(data)
                });
            },
            href: contextpath + '/domain/path.html?id='+id
        });

    }

    function refreshPathList(domainId){
        $.app.get(V3_API_URL + '/path/'+domainId, null, function (data) {
            $("#pathDg").datagrid("loadData", data.data.list);
        });
    }

    function initPathList(data){

        $("#pathDg").iDatagrid({
            idField:'ID',
            remoteSort:false,
            sortOrder:"asc",
            data:ConvertResult2Data(data),
            frozenColumns:[[
                {field: 'id', title: 'ID',  width:320,
                    sortable: true, formatter:$.iGrid.tooltipformatter()},
            ]],
            columns: [[

                {field: 'req_method', title: '请求方式',width:80,
                    sortable: true, formatter:$.iGrid.tooltipformatter()},
                {field: 'req_path', title: '请求路径',width:120,
                    sortable: true, formatter:$.iGrid.tooltipformatter()},
                {field: 'search_path', title: '路径格式',width:120,
                    sortable: true, formatter:$.iGrid.tooltipformatter()},
                {field: 'replace_path', title: '转换格式',width:120, sortable: true,
                    formatter:$.iGrid.tooltipformatter()},
                {field: 'private_proxy_enabled', title: '私有转发',width:80, sortable: true,
                    formatter:$.iGrid.checkedformatter("true", "<span class=\"cube-label cube-label-orange\">是</span>", "")},
                {field: 'circuit_breaker_enabled', title: '开启熔断',width:80, sortable: true,
                    formatter:$.iGrid.checkedformatter("true", "<span class=\"cube-label cube-label-orange\">开启</span>", "")},
                {field: 'circuit_breaker_force', title: '强制熔断',width:80, sortable: true,
                    formatter:$.iGrid.checkedformatter(true, "<span class=\"cube-label cube-label-orange\">强制</span>", "")},
                {field: 'op', title: '操作', sortable: false, width: 160, formatter:wrapPathOperate(data.data.domainId)}
            ]]
        });

        $("#pathDg").datagrid('getPager').pagination({
            layout:['info']
        });
    }

    function wrapPathOperate(domainId){
        return function (value, row, index) {
            var htmlstr = "";

            htmlstr += '<button class="layui-btn cubeui-btn-ivory layui-btn-xs" type="button" onclick="openPathDetailDiag(\''+domainId+'\', \'' + row.id + '\')">修改</button>';
            htmlstr += '<button class="cubeui-btn-gray layui-btn layui-btn-xs" type="button" onclick="delPathDetail(\''+domainId+'\', \'' + row.id + '\')">删除</button>';

            return htmlstr;
        }
    }

    function openPathDetailDiag(domainId, pathId){

        if($.extends.isEmpty(pathId) || pathId === "add" ){
            pathId = "";
        }

        $.iDialog.openDialog({
            title: '编辑',
            maximized1:true,
            minimizable:false,
            width: 1150,
            height: 600,
            render:function(opts, handler){
                let d = this;
                console.log("Open dialog")

                if(pathId == null || $.extends.isEmpty(pathId) || pathId === "add" ){
                    handler.render({})
                    $(d).dialog('setTitle', '域名路径映射：添加')
                }else{
                    $.app.get(V3_API_URL + '/path/'+domainId+"/"+pathId, null, function (data) {
                        handler.render(data.data)
                        $(d).dialog('setTitle', '域名路径映射：' + pathId)

                        if (data.data.private_proxy_enabled+'' == 'false') {
                            $("#private_proxy_enabled").switchbutton('uncheck')
                        }else{
                            $("#private_proxy_enabled").switchbutton('check')
                        }

                        if (data.data.circuit_breaker_enabled+'' == 'false') {
                            $("#circuit_breaker_enabled").switchbutton('uncheck')
                        }else{
                            $("#circuit_breaker_enabled").switchbutton('check')
                        }

                        if (data.data.circuit_breaker_force+'' == 'false') {
                            $("#circuit_breaker_force").switchbutton('uncheck')
                        }else{
                            $("#circuit_breaker_force").switchbutton('check')
                        }

                        // $("#rate_limiter_enabled").switchbutton('options').onChange = function(checked){
                        //     if(checked){
                        //         $("#rate_limiter_num").numberspinner('enable')
                        //         $("#rate_limiter_msg").numberspinner('enable')
                        //     }else{
                        //         $("#rate_limiter_num").numberspinner('disable')
                        //         $("#rate_limiter_msg").numberspinner('disable')
                        //     }
                        // }

                    });
                }

            },
            href: contextpath + '/domain/path-detail.html?id='+pathId,
            buttonsGroup: [{
                text: '保存',
                iconCls: 'fa fa-save',
                btnCls: 'cubeui-btn-blue',
                handler:'ajaxForm',
                requestType:'put',
                postJson:true,

                beforeAjax:function(o){
                    $('#contactDg').datagrid("acceptChanges")
                    var rows = $('#contactDg').datagrid('getRows');
                    if(rows.length==0){
                        $.app.showerror('请至少添加一个目标地址');
                        return false;
                    }
                    var d = [];
                    $.each(rows, function(idx, row){
                        var o = {};
                        o.pointer = row.pointer;
                        o.weight = row.weight;
                        d.push(o);
                    });

                    o.ajaxData = $.extends.json.param2json(o.ajaxData);
                    o.ajaxData.targets = d
                    //var d = $.param({contacts:$.extends.json.tostring(d)});
                    //o.ajaxData = $.extends.json.tostring(o.ajaxData)

                    $.app.debug(o.ajaxData);
                },
                reload: [{type:'datagrid', id:'pathDg', keepcheck:0, fn:function(dgObj){
                        console.log("load paths again")
                        refreshPathList(domainId)
                    }}],
                url:V3_API_URL + '/path/'+domainId+"/"+pathId
            }]
        });

        return false;
    }

    function delPathDetail(domainId, pathId){
        $.app.confirm(null, "确认删除域名路径映射"+pathId, function (){
            $.app.deleteJson(V3_API_URL + '/path/'+domainId+'/'+pathId, null, function (data) {
                $.app.show(data.msg);
                refreshPathList(domainId)
            })
        })

        return false;
    }

    function initFunction(){

        window.addrow = $.iGrid.EdatagridHandle.addRowHandle('#contactDg', function(){
        }, function(){
            return {NAME:'', QQ:'', ADDRESS:'', WORKPHONE:'', PHONE:'', ISDEFAULT:0};
        }, true);


        window.deleterow = $.iGrid.EdatagridHandle.removeRowHandle('#contactDg', function(){
        }, function(rows, success){
            success.apply();
        }, true);

        window.save = $.iGrid.EdatagridHandle.saveHandle('#contactDg', function(){
        }, function(cs, success){
            success.apply();
        }, true);

        window.cancel = $.iGrid.EdatagridHandle.rollbackHandle('#contactDg', function(){
        }, function(cs, success){
            success.apply();
        }, true, true);
    }

    APP.fn(function(){

        load();

        initFunction()
    })
</script>
</html>